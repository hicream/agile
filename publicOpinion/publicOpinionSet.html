<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>舆情工单详情</title>

        <!--<link href="/app/workflow/config/css/flowApiUpdate/workorder.css" rel="stylesheet" />
        <link href="/app/workflow/config/css/agent.css" rel="stylesheet" />
        <script type="text/javascript" src="/framework/js/framework.js" charset="UTF-8"></script>
        <script type="text/javascript" src="/framework/js/ajaxUtil.js" charset="UTF-8"></script>-->
        <link href="./mycss/workorder.css" rel="stylesheet" />
        <link href="./mycss/agent.css" rel="stylesheet" />
        <style>
            .tablelist, .tablelist .gridrlist{
                width:100%;
            }
            .edit{
                width:60%;
            }
        </style>

        <script>

        </script>

    </head>
    <body>
        <div class="orderDetail">
            <div class="tablelist" id="tableList">
                <div class='table'>
                    <table id='grid' class='gridrlist'>
                        <thead>
                            <tr>
                                <td class="">产品</td>
                                <td>舆情关键字</td>
                                <td>操作</td>
                            </tr>
                        </thead>
                        <tbody class="">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!--<script type="text/javascript" src="/app/workflow/config/js/base/jquery-1.5.2.source.js"></script>
        -->
        <script type="text/javascript" src="./myjs/jquery-1.5.2.source.js"></script>
        <script>
            //查询舆情关键字
            $(function(){
                function getSetting(){
                    var url="./publicOpinion/querySetting.json";
                    $.ajax({
                        url: url,
                        type: "GET",
                        cache: false,
                        dataType: 'json',
                        success:function(result){
                            if(result.ret)
                            appendKeyWords(result.data, initOthers);
                        }
                    })
                }
                var choice = {0: '启用抓取', 1: '暂停抓取'};
                function appendKeyWords(obj,callback){
                    for(var i=0,len=obj.length;i<len;i++){
                        var oper = '<a href="javascript:" class="operation" data-status="' + obj[i].keyWordsStatus + '">' + choice[obj[i].keyWordsStatus] + '</a>';
                        var str = '<tr data-id="' + obj[i].id + '"><td><a target="_blank" href="' + obj[i].url + '">' + obj[i].product + '</a></td><td class="edit">' + obj[i].keywords.toString() + '</td><td>' + oper + '</td></tr>';
                        $('.gridrlist tbody').append($(str));
                    }
                    callback();
                }
                getSetting();

                //edit
                function initOthers(){
                    function addForm(dest){
                        var formObj = $('<form class="changeKeyWords" style="height:24px;width:100%;display:inline-block"><input style="width: 90%; height: 20px;" autocomplete="off" type="text" name="value"><input type="submit" class="submit"><input type="reset" class="cancel" value="取消"></form>');
                        var ip =formObj.find('input[type="text"]');
                        formObj.find('.submit').click(function(){
                            var val = ip.val();
                            var id = dest.parent('tr').data('id');
                            postSetting({id: id, keywords:val.split(',')},function(){formObj.remove();dest.text(val);})
                            
                            return false;
                        });
                        formObj.find('.cancel').click(function(){
                            var parent = $(this).parents('.edit');
                            parent.text(parent.data('value'));
                            formObj.remove();
                        });
                        ip.val(dest.text());
                        dest.text('');
                        dest.append(formObj);
                    };
                    function postSetting(data,callback){
                        var url="./publicOpinion/saveSetting.json";
                        $.ajax({
                            url: url,
                            type: "POST",
                            data: data,
                            dataType: 'json',
                            success:function(result){
                                if(result.ret){
                                    callback();
                                }else{
                                    alert('update error');
                                }
                            }
                        })
                    };
                    $('.gridrlist .edit').bind('dblclick',function(){
                        $(this).data('value',$(this).text());
                        addForm($(this));
                    });

                    $('.operation').click(function(){
                        var id = $(this).parents('tr').data('id');
                        var status = $(this).data('status');
                        var stat;
                        if(status === 0){
                            stat = 1;
                        }else if(status === 1){
                            stat = 0;
                        }
                        postSetting({id:id,keyWordsStatus:stat},function(){$(this).data('status', stat);$(this).text(choice[stat]);})

                    });

                    //TODO:添加抓取网站

                };
            });
            
        </script>
    </body>
</html>
